generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  fullName  String
  passwordHash String?          // ðŸ‘ˆ make it optional for now
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  memberships WorkspaceUser[]
  notifications Notification[]

}


model Workspace {
  id   String @id @default(cuid())
  name String
  slug String @unique

  // â”€â”€ Workspace-level settings â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  companyName         String?
  primaryDomain       String?
  defaultCurrency     String   @default("EUR")          // "EUR", "USD", "GBP"
  timezone            String   @default("Europe/Prague")
  industry            String   @default("SaaS")         // for benchmarks

  plan                String   @default("pro")          // "free" | "pro" | "enterprise"
  seatsTotal          Int      @default(5)
  seatsUsed           Int      @default(1)
  billingEmail        String?

  revenuelaIdPrefix   String   @default("RVN-LEAD-")
  publicApiKey        String   @default("")
  webhookEndpoint     String   @default("")

 dataAnonymization   Boolean  @default(false)
  dataRetentionMonths Int      @default(12)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // â”€â”€ Relations (unchanged) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  users               WorkspaceUser[]
  accounts            Account[]
  contacts            Contact[]
  leads               Lead[]
  deals               Deal[]
  activities          Activity[]
  workflows           Workflow[]
  sequences           Sequence[]
  integrations        IntegrationConnection[]
  sequenceEnrollments SequenceEnrollment[] // ðŸ‘ˆ back-relation
  notifications       Notification[]   // ðŸ‘ˆ new relation

}
model Notification {
  id          String    @id @default(cuid())
  workspace   Workspace @relation(fields: [workspaceId], references: [id])
  workspaceId String

  user        User?     @relation(fields: [userId], references: [id])
  userId      String?

  type        String
  title       String
  body        String
  severity    String   @default("info") // "info" | "warning" | "error"
  isRead      Boolean  @default(false)
  createdAt   DateTime @default(now())
  readAt      DateTime?
}

model WorkspaceUser {
  id          String    @id @default(cuid())

  workspace   Workspace @relation(fields: [workspaceId], references: [id])
  workspaceId String

  user        User      @relation(fields: [userId], references: [id])
  userId      String

  // Role in this workspace
  role           String  @default("owner")   // "owner" | "admin" | "analyst" | "readonly"
  isBillingOwner Boolean @default(false)

  // Per-user preferences in this workspace
  darkMode          Boolean @default(true)
  weeklyDigest      Boolean @default(true)
  performanceAlerts Boolean @default(true)

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
}

model Account {
  id             String    @id @default(cuid())
  workspace      Workspace @relation(fields: [workspaceId], references: [id])
  workspaceId    String
  name           String
  domain         String?
  industry       String?
  employeeCount  Int?
  country        String?
  city           String?
  websiteUrl     String?
  lifecycleStage String    @default("prospect")
  ownerId        String?

  contacts   Contact[]
  leads      Lead[]
  deals      Deal[]
  activities Activity[]
  createdAt  DateTime   @default(now())
  updatedAt  DateTime   @updatedAt
}

model Contact {
  id          String    @id @default(cuid())
  workspace   Workspace @relation(fields: [workspaceId], references: [id])
  workspaceId String
  account     Account?  @relation(fields: [accountId], references: [id])
  accountId   String?
  firstName   String
  lastName    String
  email       String?
  phone       String?
  jobTitle    String?
  linkedinUrl String?
  status      String    @default("active")
  ownerId     String?

  leads               Lead[]
  deals               Deal[]
  activities          Activity[]
  sequenceEnrollments SequenceEnrollment[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Lead {
  id          String    @id @default(cuid())
  workspace   Workspace @relation(fields: [workspaceId], references: [id])
  workspaceId String
  account     Account?  @relation(fields: [accountId], references: [id])
  accountId   String?
  contact     Contact?  @relation(fields: [contactId], references: [id])
  contactId   String?
  status      String    @default("new")
  journeySteps String? 

  leadSource  String?
  leadScore   Int?
  fitScore    Int?
  ownerId     String?

  activities          Activity[]
  sequenceEnrollments SequenceEnrollment[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Deal {
  id                String    @id @default(cuid())
  workspace         Workspace @relation(fields: [workspaceId], references: [id])
  workspaceId       String
  account           Account   @relation(fields: [accountId], references: [id])
  accountId         String
  primaryContact    Contact?  @relation(fields: [primaryContactId], references: [id])
  primaryContactId  String?
  name              String
  pipeline          String    @default("new_business")
  stage             String    @default("qualification")
  amount            Float?
  currency          String?   @default("EUR")
  expectedCloseDate DateTime?
  probability       Int?
  ownerId           String?

  activities Activity[]

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  closedAt  DateTime?
}

model Activity {
  id          String    @id @default(cuid())
  workspace   Workspace @relation(fields: [workspaceId], references: [id])
  workspaceId String
  type        String
  subject     String?
  body        String?
  status      String?
  userId      String?

  account   Account? @relation(fields: [accountId], references: [id])
  accountId String?
  contact   Contact? @relation(fields: [contactId], references: [id])
  contactId String?
  lead      Lead?    @relation(fields: [leadId], references: [id])
  leadId    String?
  deal      Deal?    @relation(fields: [dealId], references: [id])
  dealId    String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Workflow {
  id            String    @id @default(cuid())
  workspace     Workspace @relation(fields: [workspaceId], references: [id])
  workspaceId   String
  name          String
  description   String?
  status        String    @default("draft")
  triggerType   String    @default("event")
  // store JSON as string for SQLite
  triggerConfig String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  nodes WorkflowNode[]
  edges WorkflowEdge[]
}

model WorkflowNode {
  id         String   @id @default(cuid())
  workflow   Workflow @relation(fields: [workflowId], references: [id])
  workflowId String
  type       String
  name       String
  positionX  Float    @default(0)
  positionY  Float    @default(0)
  // store JSON as string for SQLite
  config     String?

  outgoingEdges WorkflowEdge[] @relation("FromNode")
  incomingEdges WorkflowEdge[] @relation("ToNode")
}

model WorkflowEdge {
  id         String   @id @default(cuid())
  workflow   Workflow @relation(fields: [workflowId], references: [id])
  workflowId String

  fromNode   WorkflowNode @relation("FromNode", fields: [fromNodeId], references: [id])
  fromNodeId String

  toNode   WorkflowNode @relation("ToNode", fields: [toNodeId], references: [id])
  toNodeId String

  conditionLabel String?
}

model Sequence {
  id          String    @id @default(cuid())
  workspace   Workspace @relation(fields: [workspaceId], references: [id])
  workspaceId String
  name        String
  description String?
  type        String    @default("outbound")
  status      String    @default("draft")
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  steps       SequenceStep[]
  enrollments SequenceEnrollment[] // ðŸ‘ˆ added back-relation
}

model SequenceStep {
  id         String   @id @default(cuid())
  sequence   Sequence @relation(fields: [sequenceId], references: [id])
  sequenceId String
  stepOrder  Int
  actionType String
  delayHours Int?
  templateId String?
  // store JSON as string for SQLite
  config     String?
}

model SequenceEnrollment {
  id          String    @id @default(cuid())
  workspace   Workspace @relation(fields: [workspaceId], references: [id])
  workspaceId String
  sequence    Sequence  @relation(fields: [sequenceId], references: [id])
  sequenceId  String

  contact   Contact? @relation(fields: [contactId], references: [id])
  contactId String?

  lead   Lead?   @relation(fields: [leadId], references: [id])
  leadId String?

  status           String   @default("active")
  currentStepOrder Int?
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
}

model IntegrationConnection {
  id          String    @id @default(cuid())
  workspace   Workspace @relation(fields: [workspaceId], references: [id])
  workspaceId String
  provider    String
  status      String    @default("connected")
  // store JSON as string for SQLite
  authData    String?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
}
